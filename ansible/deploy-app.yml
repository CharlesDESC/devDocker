---
- name: Deploy DevDocker Application Stack
  hosts: app_servers
  become: true
  vars:
     project_dir: "/home/ubuntu/devdocker"
     github_user: "{{ lookup('env', 'GITHUB_USER') }}"
     github_token: "{{ lookup('env', 'GITHUB_TOKEN') }}"
     postgres_password: "{{ lookup('env', 'POSTGRES_PASSWORD') }}"

  tasks:
     # 1. Installation Docker
     - name: Update apt cache
       apt:
          update_cache: yes
          cache_valid_time: 3600

     - name: Install required packages
       apt:
          name:
             - docker.io
             - docker-compose-v2
             - python3-pip
          state: present

     - name: Add ubuntu user to docker group
       user:
          name: ubuntu
          groups: docker
          append: yes

     - name: Start and enable Docker service
       systemd:
          name: docker
          state: started
          enabled: yes

     - name: Reset SSH connection to apply group membership
       meta: reset_connection

     # 2. Authenticate to GitHub Container Registry
     - name: Login to GitHub Container Registry
       community.docker.docker_login:
          registry: ghcr.io
          username: "{{ github_user }}"
          password: "{{ github_token }}"
          reauthorize: yes
       become: yes
       become_user: ubuntu

     # 3. Create project directory
     - name: Create project directory
       file:
          path: "{{ project_dir }}"
          state: directory
          owner: ubuntu
          group: ubuntu
          mode: "0755"

     # 4. Copy docker-compose.prod.yml
     - name: Copy docker-compose production file
       copy:
          src: ../docker-compose.prod.yml
          dest: "{{ project_dir }}/docker-compose.yml"
          owner: ubuntu
          group: ubuntu
          mode: "0644"

     - name: Copy frontend files
       copy:
          src: frontend/
          dest: "{{ project_dir }}/frontend/"
          owner: ubuntu
          group: ubuntu
          mode: "0644"

     - name: Copy nginx configuration
       copy:
          src: nginx/
          dest: "{{ project_dir }}/nginx/"
          owner: ubuntu
          group: ubuntu
          mode: "0644"

     - name: Copy SQL migration files
       copy:
          src: sqlfiles/
          dest: "{{ project_dir }}/sqlfiles/"
          owner: ubuntu
          group: ubuntu
          mode: "0644"

     # 5. Create .env file with secrets
     - name: Create .env file
       copy:
          content: |
             POSTGRES_PASSWORD={{ postgres_password }}
             POSTGRES_DB=postgres
          dest: "{{ project_dir }}/.env"
          owner: ubuntu
          group: ubuntu
          mode: "0600"

     # 6. Pull images from GHCR
     - name: Pull Docker images
       community.docker.docker_compose_v2:
          project_src: "{{ project_dir }}"
          pull: always
       become: yes
       become_user: ubuntu

     # 7. Start application stack
     - name: Start application stack
       community.docker.docker_compose_v2:
          project_src: "{{ project_dir }}"
          state: present
          recreate: always
       become: yes
       become_user: ubuntu

     # 8. Wait for services to be healthy
     - name: Wait for services to start
       pause:
          seconds: 10

     # 9. Verify containers are running
     - name: Get running containers
       command: docker ps
       register: docker_ps_output
       become: yes
       become_user: ubuntu

     - name: Display running containers
       debug:
          msg: "{{ docker_ps_output.stdout_lines }}"

     # 10. Display access information
     - name: Get server public IP
       uri:
          url: http://checkip.amazonaws.com
          return_content: yes
       register: public_ip

     - name: Display application URLs
       debug:
          msg:
             - "========================================="
             - "Application deployed successfully!"
             - "========================================="
             - "Frontend: http://{{ public_ip.content | trim }}:8080"
             - "API: http://{{ public_ip.content | trim }}:8000"
             - "========================================="
