version: "3.8"

services:
   # ===========================================
   # FRONTEND - Nginx Reverse Proxy (Port 8080)
   # ===========================================
   frontend:
      image: nginx:alpine
      restart: always
      ports:
         - "8080:80"
      volumes:
         - ./frontend:/usr/share/nginx/html:ro
         - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      networks:
         - frontend-network
      depends_on:
         - api

   # ===========================================
   # BACKEND - API Python FastAPI (Port 8000)
   # ===========================================
   api:
      image: ghcr.io/charlesdesc/devdocker/api:latest
      restart: always
      ports:
         - "8000:8000"
      environment:
         POSTGRES_HOST: db
         POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
         POSTGRES_DB: ${POSTGRES_DB:-postgres}
         REDIS_HOST: redis
         REDIS_PORT: 6379
      networks:
         - frontend-network
         - backend-network
      depends_on:
         - db
         - redis

   # ===========================================
   # DATABASE - PostgreSQL avec persistance
   # ===========================================
   db:
      image: postgres:15-alpine
      restart: always
      environment:
         POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
         POSTGRES_DB: ${POSTGRES_DB:-postgres}
      volumes:
         - postgres-data:/var/lib/postgresql/data
         - ./sqlfiles:/docker-entrypoint-initdb.d:ro
      networks:
         - backend-network
      healthcheck:
         test: ["CMD-SHELL", "pg_isready -U postgres"]
         interval: 5s
         timeout: 5s
         retries: 5
         start_period: 30s

   # ===========================================
   # CACHE - Redis avec persistance
   # ===========================================
   redis:
      image: redis:7-alpine
      restart: always
      command: redis-server --appendonly yes
      volumes:
         - redis-data:/data
      networks:
         - backend-network
      healthcheck:
         test: ["CMD", "redis-cli", "ping"]
         interval: 5s
         timeout: 5s
         retries: 5

# ===========================================
# VOLUMES - Persistance des données
# ===========================================
volumes:
   postgres-data:
   redis-data:

# ===========================================
# NETWORKS - Isolation réseau
# ===========================================
networks:
   frontend-network:
      driver: bridge
   backend-network:
      driver: bridge
