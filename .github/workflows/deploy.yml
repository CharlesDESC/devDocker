name: Deploy to AWS

on:
   workflow_dispatch:
      inputs:
         environment:
            description: "Deployment environment"
            required: true
            default: "production"
            type: choice
            options:
               - production

jobs:
   # ===========================================
   # JOB 1: Build & Publish Docker Images
   # ===========================================
   build-and-publish:
      name: Build & Publish Images
      runs-on: ubuntu-latest

      steps:
         - name: Checkout repository
           uses: actions/checkout@v4

         - name: Set up Docker Buildx
           uses: docker/setup-buildx-action@v3

         - name: Login to GitHub Container Registry
           uses: docker/login-action@v3
           with:
              registry: ghcr.io
              username: ${{ github.actor }}
              password: ${{ secrets.GITHUB_TOKEN }}

         - name: Build and push API image
           run: |
              IMAGE_ID=ghcr.io/${{ github.repository }}/api
              IMAGE_ID=$(echo $IMAGE_ID | tr '[A-Z]' '[a-z]')

              docker build -t $IMAGE_ID:latest -t $IMAGE_ID:${{ github.sha }} -f python.Dockerfile .
              docker push $IMAGE_ID:latest
              docker push $IMAGE_ID:${{ github.sha }}

         - name: Image published successfully
           run: |
              echo "âœ… API image published to GHCR"
              echo "Image: ghcr.io/${{ github.repository }}/api:latest"

   # ===========================================
   # JOB 2: Provision Infrastructure with Terraform
   # ===========================================
   provision-infrastructure:
      name: Provision AWS Infrastructure
      runs-on: ubuntu-latest
      needs: build-and-publish

      outputs:
         instance_ip: ${{ steps.terraform-output.outputs.instance_ip }}

      steps:
         - name: Checkout repository
           uses: actions/checkout@v4

         - name: Configure AWS credentials
           uses: aws-actions/configure-aws-credentials@v4
           with:
              aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
              aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
              aws-region: eu-west-3

         - name: Setup Terraform
           uses: hashicorp/setup-terraform@v3
           with:
              terraform_wrapper: false

         - name: Terraform Init
           working-directory: ./infra
           run: terraform init

         - name: Terraform Plan
           working-directory: ./infra
           run: terraform plan

         - name: Terraform Apply
           working-directory: ./infra
           run: terraform apply -auto-approve

         - name: Get Terraform Outputs
           id: terraform-output
           working-directory: ./infra
           run: |
              INSTANCE_IP=$(terraform output -raw instance_ip)
              echo "instance_ip=$INSTANCE_IP" >> $GITHUB_OUTPUT
              echo "âœ… Infrastructure provisioned"
              echo "Instance IP: $INSTANCE_IP"

         - name: Save SSH private key
           working-directory: ./infra
           run: |
              terraform output -raw private_key > ../key.pem
              chmod 600 ../key.pem

         - name: Upload SSH key artifact
           uses: actions/upload-artifact@v4
           with:
              name: ssh-key
              path: key.pem
              retention-days: 1

   # ===========================================
   # JOB 3: Configure & Deploy Application
   # ===========================================
   deploy-application:
      name: Deploy Application with Ansible
      runs-on: ubuntu-latest
      needs: provision-infrastructure

      steps:
         - name: Checkout repository
           uses: actions/checkout@v4

         - name: Download SSH key
           uses: actions/download-artifact@v4
           with:
              name: ssh-key

         - name: Set SSH key permissions
           run: chmod 600 key.pem

         - name: Install Ansible
           run: |
              sudo apt-get update
              sudo apt-get install -y ansible

         - name: Install Ansible Docker collection
           run: ansible-galaxy collection install community.docker

         - name: Create dynamic inventory
           run: |
              cat > inventory.ini << EOF
              [app_servers]
              ${{ needs.provision-infrastructure.outputs.instance_ip }} ansible_user=ubuntu ansible_ssh_private_key_file=key.pem ansible_ssh_common_args='-o StrictHostKeyChecking=no'
              EOF
              cat inventory.ini

         - name: Wait for SSH to be ready
           run: |
              for i in {1..30}; do
                if ssh -i key.pem -o StrictHostKeyChecking=no ubuntu@${{ needs.provision-infrastructure.outputs.instance_ip }} "echo SSH Ready"; then
                  echo "âœ… SSH connection established"
                  break
                fi
                echo "Waiting for SSH... ($i/30)"
                sleep 10
              done

         - name: Run Ansible playbook
           env:
              GITHUB_USER: ${{ github.actor }}
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
           run: |
              ansible-playbook \
                -i inventory.ini \
                ansible/deploy-app.yml \
                -e "github_user=$GITHUB_USER" \
                -e "github_token=$GITHUB_TOKEN" \
                -e "postgres_password=$POSTGRES_PASSWORD" \
                -v

         - name: Deployment Summary
           run: |
              echo "========================================="
              echo "ðŸŽ‰ Deployment completed successfully!"
              echo "========================================="
              echo ""
              echo "ðŸ“ Application URLs:"
              echo "   Frontend: http://${{ needs.provision-infrastructure.outputs.instance_ip }}:8080"
              echo "   API:      http://${{ needs.provision-infrastructure.outputs.instance_ip }}:8000"
              echo ""
              echo "========================================="

         - name: Create deployment summary
           run: |
              cat >> $GITHUB_STEP_SUMMARY << EOF
              # ðŸš€ Deployment Successful

              ## Application Access

              - **Frontend**: http://${{ needs.provision-infrastructure.outputs.instance_ip }}:8080
              - **API**: http://${{ needs.provision-infrastructure.outputs.instance_ip }}:8000

              ## Infrastructure Details

              - **Instance IP**: ${{ needs.provision-infrastructure.outputs.instance_ip }}
              - **Region**: eu-west-3 (Paris)
              - **Instance Type**: t3.micro

              ## Next Steps

              1. Open the frontend URL to verify the application
              2. Check that the student dashboard displays correctly
              3. To destroy the infrastructure, run: \`cd infra && terraform destroy\`
              EOF
